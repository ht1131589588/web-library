<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Redux 源码探索 | 时羽·前端知识库</title>
    <meta name="description" content="前端,前端工程师,前端自学,前端进阶,前端发展">
    
    
    <link rel="preload" href="/assets/css/0.styles.1ea483f6.css" as="style"><link rel="preload" href="/assets/js/app.da8adb1d.js" as="script"><link rel="preload" href="/assets/js/2.96de6bcb.js" as="script"><link rel="preload" href="/assets/js/39.ab623e87.js" as="script"><link rel="prefetch" href="/assets/js/10.241d32d2.js"><link rel="prefetch" href="/assets/js/11.a6831e54.js"><link rel="prefetch" href="/assets/js/12.adcd6c84.js"><link rel="prefetch" href="/assets/js/13.ee439a5a.js"><link rel="prefetch" href="/assets/js/14.3c912610.js"><link rel="prefetch" href="/assets/js/15.1ef78249.js"><link rel="prefetch" href="/assets/js/16.abff9c02.js"><link rel="prefetch" href="/assets/js/17.3d4be703.js"><link rel="prefetch" href="/assets/js/18.1ddd33b9.js"><link rel="prefetch" href="/assets/js/19.eba6f6ef.js"><link rel="prefetch" href="/assets/js/20.1f20a295.js"><link rel="prefetch" href="/assets/js/21.2ddcddb0.js"><link rel="prefetch" href="/assets/js/22.d2320752.js"><link rel="prefetch" href="/assets/js/23.ea5638f0.js"><link rel="prefetch" href="/assets/js/24.21022535.js"><link rel="prefetch" href="/assets/js/25.c9cee89b.js"><link rel="prefetch" href="/assets/js/26.6f85fc67.js"><link rel="prefetch" href="/assets/js/27.ab88f00b.js"><link rel="prefetch" href="/assets/js/28.d4d19997.js"><link rel="prefetch" href="/assets/js/29.d6722fdf.js"><link rel="prefetch" href="/assets/js/3.350bb032.js"><link rel="prefetch" href="/assets/js/30.dbab78d1.js"><link rel="prefetch" href="/assets/js/31.b1a95078.js"><link rel="prefetch" href="/assets/js/32.ad603326.js"><link rel="prefetch" href="/assets/js/33.df9cbf21.js"><link rel="prefetch" href="/assets/js/34.fd307270.js"><link rel="prefetch" href="/assets/js/35.95600bfc.js"><link rel="prefetch" href="/assets/js/36.b94b68ea.js"><link rel="prefetch" href="/assets/js/37.5ba3a878.js"><link rel="prefetch" href="/assets/js/38.edc16a3e.js"><link rel="prefetch" href="/assets/js/4.869a7c72.js"><link rel="prefetch" href="/assets/js/40.ad94d9f9.js"><link rel="prefetch" href="/assets/js/41.295de8ff.js"><link rel="prefetch" href="/assets/js/5.99669916.js"><link rel="prefetch" href="/assets/js/6.d6e3272a.js"><link rel="prefetch" href="/assets/js/7.51b7c828.js"><link rel="prefetch" href="/assets/js/8.75780f47.js"><link rel="prefetch" href="/assets/js/9.c6b9315b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1ea483f6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">时羽·前端知识库</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/blog/" class="nav-link">博客</a></div><div class="nav-item"><a href="/AlgorithmAndDataStructure/" class="nav-link">数据结构与算法</a></div><div class="nav-item"><a href="/front/" class="nav-link router-link-active">前端</a></div><div class="nav-item"><a href="/nodejs/" class="nav-link">Nodejs</a></div><div class="nav-item"><a href="/extends/" class="nav-link">扩展</a></div><div class="nav-item"><a href="https://github.com/ht1131589588/web-library" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/blog/" class="nav-link">博客</a></div><div class="nav-item"><a href="/AlgorithmAndDataStructure/" class="nav-link">数据结构与算法</a></div><div class="nav-item"><a href="/front/" class="nav-link router-link-active">前端</a></div><div class="nav-item"><a href="/nodejs/" class="nav-link">Nodejs</a></div><div class="nav-item"><a href="/extends/" class="nav-link">扩展</a></div><div class="nav-item"><a href="https://github.com/ht1131589588/web-library" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>React系列</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/front/React/React使用总结.html" class="sidebar-link">React使用总结</a></li><li><a href="/front/React/Redux源码探索.html" class="active sidebar-link">Redux 源码探索</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front/React/Redux源码探索.html#文件结构" class="sidebar-link">文件结构</a></li><li class="sidebar-sub-header"><a href="/front/React/Redux源码探索.html#入口文件" class="sidebar-link">入口文件</a></li><li class="sidebar-sub-header"><a href="/front/React/Redux源码探索.html#创建仓库-createstore" class="sidebar-link">创建仓库 - createStore()</a></li><li class="sidebar-sub-header"><a href="/front/React/Redux源码探索.html#组合reducer-combinereducers" class="sidebar-link">组合reducer - combineReducers()</a></li><li class="sidebar-sub-header"><a href="/front/React/Redux源码探索.html#添加中间件-applymiddleware" class="sidebar-link">添加中间件 - applyMiddleware()</a></li><li class="sidebar-sub-header"><a href="/front/React/Redux源码探索.html#绑定actioncreator-bindactioncreators" class="sidebar-link">绑定actionCreator - bindActionCreators</a></li><li class="sidebar-sub-header"><a href="/front/React/Redux源码探索.html#组合函数-compose" class="sidebar-link">组合函数 - compose</a></li><li class="sidebar-sub-header"><a href="/front/React/Redux源码探索.html#参考链接" class="sidebar-link">参考链接</a></li></ul></li><li><a href="/front/React/React常见面试题.html" class="sidebar-link">React 常见面试题</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="redux-源码探索"><a href="#redux-源码探索" aria-hidden="true" class="header-anchor">#</a> Redux 源码探索</h1> <p>阅读redux源码，可以让我们在实践中更好使用它，也可以学习它来初步认JS识函数式编程</p> <h2 id="文件结构"><a href="#文件结构" aria-hidden="true" class="header-anchor">#</a> 文件结构</h2> <div class="language- extra-class"><pre class="language-text"><code>|-- src
    |-- applyMiddleware.js  将middleware串联起来生成一个更强大的dispatch函数，就是中间件的本质作用
    |-- bindActionCreators.js  将action creators转换成拥有同名keys的action对象
    |-- combineReducers.js  将多个reducer组合起来，每一个reducer独立管理自己对应的state
    |-- compose.js  函数式编程中的组合函数，在applyMiddleware中调用，将middleware从右向左依次调用，生成一个从左向右执行middleware的dispatch增强函数
    |-- createStore.js  核心功能，创建一个store，实现了4个核心函数，dispatch、subscribe、getState、replaceReducer
    |-- index.js 对外暴露api
    |-- utils 供其他的函数调用的工具函数或变量
        |-- actionTypes.js 内置action type变量，用于初始化/重置 state
        |-- isPlainObject.js 用于校验是否是纯对象
        |-- warning.js 错误提示函数
</code></pre></div><h2 id="入口文件"><a href="#入口文件" aria-hidden="true" class="header-anchor">#</a> 入口文件</h2> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> __DO_NOT_USE__ActionTypes <span class="token keyword">from</span> <span class="token string">'./utils/actionTypes'</span>

<span class="token comment">// 仅用于判断代码是否被压缩</span>
<span class="token keyword">function</span> <span class="token function">isCrushed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// 如果非生产环境压缩了代码会提示用户，使用压缩后的redux代码会降低性能</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>
  process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span>
  <span class="token keyword">typeof</span> isCrushed<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">&amp;&amp;</span>
  isCrushed<span class="token punctuation">.</span>name <span class="token operator">!==</span> <span class="token string">'isCrushed'</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">warning</span><span class="token punctuation">(</span><span class="token string">'~~~'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span>
  createStore<span class="token punctuation">,</span>
  combineReducers<span class="token punctuation">,</span>
  bindActionCreators<span class="token punctuation">,</span>
  applyMiddleware<span class="token punctuation">,</span>
  compose<span class="token punctuation">,</span>
  __DO_NOT_USE__ActionTypes
<span class="token punctuation">}</span>

</code></pre></div><pre><code>注意：actionTypes被暴露出去，但是并不希望被外部使用
</code></pre> <h2 id="创建仓库-createstore"><a href="#创建仓库-createstore" aria-hidden="true" class="header-anchor">#</a> 创建仓库 - <code>createStore()</code></h2> <p><code>createStore</code> 函数：</p> <ul><li>输入三个参数：<code>reducer</code> ，<code>preloadedState</code> ， <code>enhancer</code> <ul><li><code>reducer</code> 需要是一个纯函数，相同的输入，一定会返回相同的输出</li> <li><code>preloadedState</code> 初始值</li> <li><code>enhancer</code> 中文意思为<code>增强器</code>，意思就是这里可以引入第三方库，来增强store功能，redux的唯一增强器是 <code>applyMiddleware()</code> ，用于引入中间件来增强dispatch函数</li></ul></li> <li>返回了4个主要函数：
<ul><li><code>dispatch</code> : 发起<code>action</code>，执行<code>reducer</code>函数，如果有中间件，dispatch发起的<code>action</code>会经过中间件的扩展，然后再执行<code>reducer</code>函数</li> <li><code>subscribe</code> : 用于添加对state的订阅</li> <li><code>getState</code> : 获取state</li> <li><code>replaceReducer</code> : 动态替换reducer</li></ul></li> <li>5个内部变量：
<ul><li><code>currentReducer</code> : 保存当前的<code>reducer</code></li> <li><code>currentState</code> : 保存应用的全局<code>store</code>状态</li> <li><code>currentListeners</code> : 保存当前的订阅函数数组</li> <li><code>nextListeners</code> : 订阅函数数组的快照，避免直接修改<code>currentListeners</code></li> <li><code>isDispatching</code> : 用于标识是否正在触发一个<code>action</code></li></ul></li></ul> <p>下面再来看一下 <code>createStore</code> 源码实现：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// src/createStore.js</span>
<span class="token keyword">function</span> <span class="token function">createStore</span><span class="token punctuation">(</span><span class="token parameter">reducer<span class="token punctuation">,</span> preloadedState<span class="token punctuation">,</span> enhancer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 这段代码用于判断传递的参数是否符合规范</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token keyword">typeof</span> preloadedState <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> enhancer <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token operator">||</span>
    <span class="token punctuation">(</span><span class="token keyword">typeof</span> enhancer <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> arguments<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
      <span class="token string">'It looks like you are passing several store enhancers to '</span> <span class="token operator">+</span>
        <span class="token string">'createStore(). This is not supported. Instead, compose them '</span> <span class="token operator">+</span>
        <span class="token string">'together to a single function.'</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 判断第二个参数为function时，第三个参数又不存在时，把第二个参数作为enhancer</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> preloadedState <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> enhancer <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    enhancer <span class="token operator">=</span> preloadedState
    preloadedState <span class="token operator">=</span> <span class="token keyword">undefined</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 如果 enhancer 函数存在，执行 enhancer 函数，并且不再继续执行下去</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> enhancer <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> enhancer <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Expected the enhancer to be a function.'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">enhancer</span><span class="token punctuation">(</span>createStore<span class="token punctuation">)</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> preloadedState<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// reducer是必选参数且必须是一个函数</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> reducer <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Expected the reducer to be a function.'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 声明内部使用变量</span>
  <span class="token comment">// 存储值</span>
  <span class="token keyword">let</span> currentReducer <span class="token operator">=</span> reducer
  <span class="token comment">// 设置默认state</span>
  <span class="token keyword">let</span> currentState <span class="token operator">=</span> preloadedState
  <span class="token comment">// 存放回调函数的订阅数组</span>
  <span class="token keyword">let</span> currentListeners <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">// 下一次的订阅数组</span>
  <span class="token keyword">let</span> nextListeners <span class="token operator">=</span> currentListeners
  <span class="token comment">// 用于防止在执行reducer函数时再次触发dispatch函数</span>
  <span class="token keyword">let</span> isDispatching <span class="token operator">=</span> <span class="token boolean">false</span>

  <span class="token comment">/**
   * 浅拷贝一份currentListeners 为下一阶段监听器提供快照
   * 用于防止在触发订阅/取消订阅回调函数时出现错误
   */</span>
  <span class="token keyword">function</span> <span class="token function">ensureCanMutateNextListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextListeners <span class="token operator">===</span> currentListeners<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      nextListeners <span class="token operator">=</span> currentListeners<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 获取state
   * @returns {any} 返回currentState
   */</span>
  <span class="token keyword">function</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 正在执行dispatch函数时不能获取，其实一般情况下不会出现这种情况</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isDispatching<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
        <span class="token string">'You may not call store.getState() while the reducer is executing. '</span> <span class="token operator">+</span>
          <span class="token string">'The reducer has already received the state as an argument. '</span> <span class="token operator">+</span>
          <span class="token string">'Pass it down from the top reducer instead of reading it from the store.'</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> currentState
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 用于订阅state的更新
   *
   * @param {Function} listener 订阅函数
   * @returns {Function} 返回可以移除listener的函数
   */</span>
  <span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">listener</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 传入的listener必须是一个函数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> listener <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Expected the listener to be a function.'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 保证纯函数不带来副作用</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isDispatching<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
        <span class="token string">'You may not call store.subscribe() while the reducer is executing. '</span> <span class="token operator">+</span>
          <span class="token string">'If you would like to be notified after the store has been updated, subscribe from a '</span> <span class="token operator">+</span>
          <span class="token string">'component and invoke store.getState() in the callback to access the latest state. '</span> <span class="token operator">+</span>
          <span class="token string">'See https://redux.js.org/api-reference/store#subscribe(listener) for more details.'</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> isSubscribed <span class="token operator">=</span> <span class="token boolean">true</span>
    
    <span class="token comment">// 只有第一次执行或者每次dispatch之后的第一次subscribe时会把 currentListeners 拷贝并覆盖 nextListeners 中</span>
    <span class="token function">ensureCanMutateNextListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// nextListeners 新增listener，currentListeners并不会新增</span>
    nextListeners<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span>
    
    <span class="token comment">// 取消订阅</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isSubscribed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 保证纯函数不带来副作用</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isDispatching<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
          <span class="token string">'You may not unsubscribe from a store listener while the reducer is executing. '</span> <span class="token operator">+</span>
            <span class="token string">'See https://redux.js.org/api-reference/store#subscribe(listener) for more details.'</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      isSubscribed <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token comment">// 取消订阅后 把 currentListeners 拷贝并覆盖 nextListeners 中</span>
      <span class="token function">ensureCanMutateNextListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> index <span class="token operator">=</span> nextListeners<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span>
      <span class="token comment">// 从nextListeners中删除unsubscribe的listener</span>
      nextListeners<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token comment">// 清空当前的订阅数组</span>
      currentListeners <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 用于执行reducer函数的函数
   */</span>
  <span class="token keyword">function</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 保证action是个纯对象，即字面量对象或Object创建的对象</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
        <span class="token string">'Actions must be plain objects. '</span> <span class="token operator">+</span>
          <span class="token string">'Use custom middleware for async actions.'</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// action必须有type属性存在</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> action<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
        <span class="token string">'Actions may not have an undefined &quot;type&quot; property. '</span> <span class="token operator">+</span>
          <span class="token string">'Have you misspelled a constant?'</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 正在执行reducer函数时不允许再次触发</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isDispatching<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Reducers may not dispatch actions.'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      isDispatching <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token comment">// 执行reducer</span>
      currentState <span class="token operator">=</span> <span class="token function">currentReducer</span><span class="token punctuation">(</span>currentState<span class="token punctuation">,</span> action<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      isDispatching <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 通知所有之前通过subscribe订阅state更新的回调listener</span>
    <span class="token keyword">const</span> listeners <span class="token operator">=</span> <span class="token punctuation">(</span>currentListeners <span class="token operator">=</span> nextListeners<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> listeners<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> listener <span class="token operator">=</span> listeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      <span class="token function">listener</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> action
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 用于替换当前存储的reducer函数
   * 比如当你需要进行代码拆分或者想要动态加载一些reducer、想要为redux实现热重载时
   *
   * @param {Function} nextReducer 用于替换 store 中的 reducer
   * @returns {void}
   */</span>
  <span class="token keyword">function</span> <span class="token function">replaceReducer</span><span class="token punctuation">(</span><span class="token parameter">nextReducer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> nextReducer <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Expected the nextReducer to be a function.'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    currentReducer <span class="token operator">=</span> nextReducer

    <span class="token comment">// ActionTypes.REPLACE其实就是ActionTypes.INIT</span>
    <span class="token comment">// 重新INIT依次是为了获取新的reducer中的默认参数</span>
    <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> ActionTypes<span class="token punctuation">.</span><span class="token constant">REPLACE</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 用于观察和响应的互通 私有属性，暂时并未不做扩充</span>
  <span class="token keyword">function</span> <span class="token function">observable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> outerSubscribe <span class="token operator">=</span> subscribe
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token comment">/**
       * The minimal observable subscription method.
       * @param {Object} observer Any object that can be used as an observer.
       * The observer object should have a `next` method.
       * @returns {subscription} An object with an `unsubscribe` method that can
       * be used to unsubscribe the observable from the store, and prevent further
       * emission of values from the observable.
       */</span>
      <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">observer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> observer <span class="token operator">!==</span> <span class="token string">'object'</span> <span class="token operator">||</span> observer <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Expected the observer to be an object.'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">function</span> <span class="token function">observeState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>observer<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            observer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token function">observeState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> unsubscribe <span class="token operator">=</span> <span class="token function">outerSubscribe</span><span class="token punctuation">(</span>observeState<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> unsubscribe <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>

      <span class="token punctuation">[</span>$$observable<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// reducer要求对无法识别的action返回state，就是因为需要通过ActionTypes.INIT获取默认参数值并返回</span>
  <span class="token comment">// 当initailState和reducer的参数默认值都存在的时候，reducer参数默认值将不起作用</span>
  <span class="token comment">// 因为在createStore声明变量时currState就已经被赋值了initialState</span>
  <span class="token comment">// 同时这个initialState也是服务端渲染的初始状态入口</span>
  <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> ActionTypes<span class="token punctuation">.</span><span class="token constant">INIT</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    dispatch<span class="token punctuation">,</span>
    subscribe<span class="token punctuation">,</span>
    getState<span class="token punctuation">,</span>
    replaceReducer<span class="token punctuation">,</span>
    <span class="token punctuation">[</span>$$observable<span class="token punctuation">]</span><span class="token punctuation">:</span> observable
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>总结以下几点注意事项：</p> <ol><li>enhancer</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token comment">// 判断第二个参数为function时，第三个参数又不存在时，把第二个参数作为enhancer</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> preloadedState <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> enhancer <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    enhancer <span class="token operator">=</span> preloadedState
    preloadedState <span class="token operator">=</span> <span class="token keyword">undefined</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 如果 enhancer 函数存在，执行 enhancer 函数，并且不再继续执行下去</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> enhancer <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> enhancer <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Expected the enhancer to be a function.'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">enhancer</span><span class="token punctuation">(</span>createStore<span class="token punctuation">)</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> preloadedState<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>首先<code>enhancer</code>在缺省条件下，如果<code>preloadedState</code>是个函数，则将其视为<code>enhancer</code>。
<code>enhancer</code>本身是个引入中间件扩展功能的返回函数，<code>enhancer(createStore)(reducer, preloadedState)</code>实际上是输出一个增强了<code>dispatch</code>功能的<code>store</code>
2. <code>nextListeners</code>及<code>currentListeners</code>
currentListeners 为当前的 listener, nextListeners 为下次 dispatch 后才发布的订阅者集合</p> <p>对listener做深拷贝的原因是因为如果在listener中进行unsubscribe操作，比如有3个listener(下标0,1,2)，在第2个listener执行时unsubscribe了自己，那么第3个listener的下标就变成了1，但是for循环下一轮的下标是2，第3个listener就被跳过了，所以执行一次深拷贝，即使在listener过程中unsubscribe了也是更改的nextListeners（nextListeners会去深拷贝currentListeners）。当前执行的currentListeners不会被修改，第3个listener就不会被跳过了。</p> <ol start="3"><li>observable 这个方法是为Rxjs准备的，如果不使用RxJS可以忽略，在这里略过。</li> <li>replaceReducer 用于动态替换整个store的reducer</li></ol> <h2 id="组合reducer-combinereducers"><a href="#组合reducer-combinereducers" aria-hidden="true" class="header-anchor">#</a> 组合reducer - <code>combineReducers()</code></h2> <p>用来将若干个reducer合并成一个reducers
源码大部分都是用来校验数据、抛出错误
辅助方法说明：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 用于</span>
<span class="token keyword">function</span> <span class="token function">getUndefinedStateErrorMessage</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> actionType <span class="token operator">=</span> action <span class="token operator">&amp;&amp;</span> action<span class="token punctuation">.</span>type
  <span class="token keyword">const</span> actionDescription <span class="token operator">=</span>
    <span class="token punctuation">(</span>actionType <span class="token operator">&amp;&amp;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">action &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">String</span><span class="token punctuation">(</span>actionType<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'an action'</span>
  <span class="token comment">// 即使没有值应该返回null，而不要返回undefined</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Given </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>actionDescription<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, reducer &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; returned undefined. </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">To ignore an action, you must explicitly return the previous state. </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">If you want this reducer to hold no value, you can return null instead of undefined.</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getUnexpectedStateShapeWarningMessage</span><span class="token punctuation">(</span>
  <span class="token parameter">inputState<span class="token punctuation">,</span>
  reducers<span class="token punctuation">,</span>
  action<span class="token punctuation">,</span>
  unexpectedKeyCache</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> reducerKeys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>reducers<span class="token punctuation">)</span>
  <span class="token comment">// 判断actionType是来自redux内部init type还是其他的</span>
  <span class="token keyword">const</span> argumentName <span class="token operator">=</span>
    action <span class="token operator">&amp;&amp;</span> action<span class="token punctuation">.</span>type <span class="token operator">===</span> ActionTypes<span class="token punctuation">.</span><span class="token constant">INIT</span>
      <span class="token operator">?</span> <span class="token string">'preloadedState argument passed to createStore'</span>
      <span class="token punctuation">:</span> <span class="token string">'previous state received by the reducer'</span>

  <span class="token comment">// 监测是否没有传递reducer</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>reducerKeys<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token string">'Store does not have a valid reducer. Make sure the argument passed '</span> <span class="token operator">+</span>
      <span class="token string">'to combineReducers is an object whose values are reducers.'</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// state必须是个纯对象</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>inputState<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>argumentName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> has unexpected type of &quot;</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
      <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>inputState<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/\s([a-z|A-Z]+)/</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&quot;. Expected argument to be an object with the following </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">keys: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>reducerKeys<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'&quot;, &quot;'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 判断combineReducer合并的reducer个数是否和finalReducers个数是否相同</span>
  <span class="token comment">// 并获取不相同的key</span>
  <span class="token keyword">const</span> unexpectedKeys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>inputState<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>
    <span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span>reducers<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>unexpectedKeyCache<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token punctuation">)</span>
  <span class="token comment">// 标记不相同的key</span>
  unexpectedKeys<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    unexpectedKeyCache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 当是调用replaceReducers时，就不需要再判断，直接返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">&amp;&amp;</span> action<span class="token punctuation">.</span>type <span class="token operator">===</span> ActionTypes<span class="token punctuation">.</span><span class="token constant">REPLACE</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
  <span class="token comment">// 告诉你有什么值是多出来的，会被忽略掉</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>unexpectedKeys<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Unexpected </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>unexpectedKeys<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token string">'keys'</span> <span class="token punctuation">:</span> <span class="token string">'key'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>unexpectedKeys<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'&quot;, &quot;'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; found in </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>argumentName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">. </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Expected to find one of the known reducer keys instead: </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>reducerKeys<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'&quot;, &quot;'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;. Unexpected keys will be ignored.</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 用来判断初始化和随机状态下返回的是不是 undefined</span>
<span class="token keyword">function</span> <span class="token function">assertReducerShape</span><span class="token punctuation">(</span><span class="token parameter">reducers</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>reducers<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 遍历 reducer</span>
    <span class="token keyword">const</span> reducer <span class="token operator">=</span> reducers<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token comment">// 初始化 reducer，得到一个state值</span>
    <span class="token keyword">const</span> initialState <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> ActionTypes<span class="token punctuation">.</span><span class="token constant">INIT</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 初始化状态下 state 不能返回undefined</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> initialState <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Reducer &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; returned undefined during initialization. </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">If the state passed to the reducer is undefined, you must </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">explicitly return the initial state. The initial state may </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">not be undefined. If you don't want to set a value for this reducer, </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">you can use null instead of undefined.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 随机状态下 state 也能返回undefined</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token keyword">typeof</span> <span class="token function">reducer</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        type<span class="token punctuation">:</span> ActionTypes<span class="token punctuation">.</span><span class="token constant">PROBE_UNKNOWN_ACTION</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'undefined'</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Reducer &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; returned undefined when probed with a random type. </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Don't try to handle </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ActionTypes<span class="token punctuation">.</span><span class="token constant">INIT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> or other actions in &quot;redux/*&quot; </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">namespace. They are considered private. Instead, you must return the </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">current state for any unknown actions, unless it is undefined, </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">in which case you must return the initial state, regardless of the </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">action type. The initial state may not be undefined, but can be null.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><p>主要函数说明：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">combineReducers</span><span class="token punctuation">(</span><span class="token parameter">reducers</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取传入reducers的所有key</span>
  <span class="token keyword">const</span> reducerKeys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>reducers<span class="token punctuation">)</span>
  <span class="token comment">// 最后真正有效的reducer存在这里</span>
  <span class="token keyword">const</span> finalReducers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// 筛选出有效的reducer</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> reducerKeys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> reducerKeys<span class="token punctuation">[</span>i<span class="token punctuation">]</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> reducers<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warning</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">No reducer provided for key &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// reducer必须是函数，无效的数据不会被合并进来</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> reducers<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      finalReducers<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> reducers<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 所有可用reducer</span>
  <span class="token keyword">const</span> finalReducerKeys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>finalReducers<span class="token punctuation">)</span>

  <span class="token comment">// This is used to make sure we don't warn about the same</span>
  <span class="token comment">// keys multiple times.</span>
  <span class="token comment">// 用于配合getUnexpectedStateShapeWarningMessage辅助函数过滤掉多出来的值</span>
  <span class="token keyword">let</span> unexpectedKeyCache
  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unexpectedKeyCache <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> shapeAssertionError
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 校验reducers是否都是有效数据</span>
    <span class="token function">assertReducerShape</span><span class="token punctuation">(</span>finalReducers<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    shapeAssertionError <span class="token operator">=</span> e
  <span class="token punctuation">}</span>

  <span class="token comment">// 返回一个合并后的 reducer 函数，与普通的 reducer 一样</span>
  <span class="token comment">// 主要逻辑：取得每个子reducer对应的state，与action一起作为参数给每个子reducer执行。</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">combination</span><span class="token punctuation">(</span><span class="token parameter">state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shapeAssertionError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> shapeAssertionError
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 开发环境下校验有哪些值是多出来的</span>
      <span class="token keyword">const</span> warningMessage <span class="token operator">=</span> <span class="token function">getUnexpectedStateShapeWarningMessage</span><span class="token punctuation">(</span>
        state<span class="token punctuation">,</span>
        finalReducers<span class="token punctuation">,</span>
        action<span class="token punctuation">,</span>
        unexpectedKeyCache
      <span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>warningMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warning</span><span class="token punctuation">(</span>warningMessage<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> hasChanged <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token comment">// 标志state是否有变化</span>
    <span class="token keyword">const</span> nextState <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token comment">// 下面就会进行获取reducer对应的state，与action一起作为参数给每个子reducer执行。</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> finalReducerKeys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 获取本次循环的子reducer</span>
      <span class="token keyword">const</span> key <span class="token operator">=</span> finalReducerKeys<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      <span class="token keyword">const</span> reducer <span class="token operator">=</span> finalReducers<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
      <span class="token comment">// 获取该子reducer对应的旧的state</span>
      <span class="token keyword">const</span> previousStateForKey <span class="token operator">=</span> state<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
      <span class="token comment">// 该子reducer执行后返回的新的state</span>
      <span class="token keyword">const</span> nextStateForKey <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span>previousStateForKey<span class="token punctuation">,</span> action<span class="token punctuation">)</span>
      <span class="token comment">// 如果新的state是undefined就抛出对应错误</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> nextStateForKey <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> errorMessage <span class="token operator">=</span> <span class="token function">getUndefinedStateErrorMessage</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> action<span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>errorMessage<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 用新的state替换旧的state</span>
      nextState<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> nextStateForKey
      <span class="token comment">// 判断state是否改变</span>
      hasChanged <span class="token operator">=</span> hasChanged <span class="token operator">||</span> nextStateForKey <span class="token operator">!==</span> previousStateForKey
    <span class="token punctuation">}</span>
    <span class="token comment">// 改变后返回新的state，未改变返回旧的值</span>
    <span class="token keyword">return</span> hasChanged <span class="token operator">?</span> nextState <span class="token punctuation">:</span> state
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="添加中间件-applymiddleware"><a href="#添加中间件-applymiddleware" aria-hidden="true" class="header-anchor">#</a> 添加中间件 - <code>applyMiddleware()</code></h2> <p>applyMiddleware，顾名思义，就是运用中间件。
作用：把一系列中间件转换为增强<code>dispatch</code>的函数<code>enhancer</code>
源码只有20行，主要内容只有十几行，如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>middlewares</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// middlewares 为传入的一系列中间件，等待调用</span>
  <span class="token comment">// 这里返回的就是enhancer，enhancer会接收createStore并返回一个函数</span>
  <span class="token comment">// 在createStore中，当存在enhancer时，拦截了createStore下面需要执行的代码，</span>
  <span class="token comment">// 返回执行enhancer(createStore)(reducer, preloadedState)的结果</span>
  <span class="token keyword">return</span> <span class="token parameter">createStore</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 执行enhancer(createStore)(reducer, preloadedState)是会调用下面代码</span>
    <span class="token comment">// 继续执行createStore，返回store</span>
    <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
    <span class="token keyword">let</span> <span class="token function-variable function">dispatch</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
        <span class="token string">'Dispatching while constructing your middleware is not allowed. '</span> <span class="token operator">+</span>
          <span class="token string">'Other middleware would not be applied to this dispatch.'</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 传递给中间件使用的api</span>
    <span class="token keyword">const</span> middlewareAPI <span class="token operator">=</span> <span class="token punctuation">{</span>
      getState<span class="token punctuation">:</span> store<span class="token punctuation">.</span>getState<span class="token punctuation">,</span>
      <span class="token function-variable function">dispatch</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 遍历并执行中间件函数，把执行结果存放于chain</span>
    <span class="token comment">// 每一个中间件函数的返回值是一个改造的dispatch函数</span>
    <span class="token keyword">const</span> chain <span class="token operator">=</span> middlewares<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">middleware</span> <span class="token operator">=&gt;</span> <span class="token function">middleware</span><span class="token punctuation">(</span>middlewareAPI<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 用compose去改造dispatch函数，得到一个增强的dispatch函数</span>
    dispatch <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token operator">...</span>chain<span class="token punctuation">)</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>dispatch<span class="token punctuation">)</span>
    <span class="token comment">// compose(func1,func2,func3)</span>
    <span class="token comment">// 返回一个函数: (...args) =&gt; func1( func2( func3(...args) ) )</span>
    <span class="token comment">// 传入的dispatch被func3改造后得到一个新的dispatch，新的dispatch继续被func2改造.</span>
    <span class="token comment">// 因此每个中间件内部必须执行dispatch才会继续下一个中间件的调用</span>

    <span class="token comment">// 继续返回store，并用加强版的dispatch覆盖旧的dispatch</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>store<span class="token punctuation">,</span>
      dispatch
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>编写一个最简单的符合规范的中间件：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">logger</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> dispatch<span class="token punctuation">,</span> getState <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// middlewareAPI  中包含了dispatch, getState这两个方法</span>
  <span class="token comment">// 但是调用middlewareAPI的dispatch函数会抛出异常，可以查看上面源码</span>
  <span class="token comment">// 返回真正的中间件执行函数 下面的next就是增强的dispatch</span>
  <span class="token keyword">return</span> <span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token parameter">action</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'logger'</span><span class="token punctuation">)</span>
      <span class="token comment">// 执行改中间件任务</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>type <span class="token operator">+</span> <span class="token string">'执行了！！！'</span><span class="token punctuation">)</span>
      <span class="token comment">// 执行下一个中间件</span>
      <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 实现异步的中间件 - thunk redux-thunk也是这样实现的，不过加了层函数包裹，实现传递参额外参数</span>
<span class="token keyword">const</span> <span class="token function-variable function">thunk</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>dispatch<span class="token punctuation">,</span> getState<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token parameter">action</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> action <span class="token operator">==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">action</span><span class="token punctuation">(</span>dispatch<span class="token punctuation">,</span> getState<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="绑定actioncreator-bindactioncreators"><a href="#绑定actioncreator-bindactioncreators" aria-hidden="true" class="header-anchor">#</a> 绑定actionCreator - <code>bindActionCreators</code></h2> <p>作用： 实际上就是通过返回一个高阶函数，通过闭包应用，将dispatch隐藏起来，正常发起一个dispatch(action)，但是bindActionCreators将dispatch隐藏，当执行bindActionCreators时：</p> <ul><li>如果传入的是一个函数，就认为传入了一个actionCreator，转换成这样：() =&gt; dispatch(actionCreators(...arguments))</li> <li>如果传入的是对象，包含多个actionCreator，就会遍历返回一个对象的对象，对每个key值都进行上面的转换</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 返回一个高阶函数</span>
<span class="token keyword">function</span> <span class="token function">bindActionCreator</span><span class="token punctuation">(</span><span class="token parameter">actionCreator<span class="token punctuation">,</span> dispatch</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 执行actionCreator，获取action，再用dispatch进行派发action</span>
    <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">actionCreator</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">bindActionCreators</span><span class="token punctuation">(</span><span class="token parameter">actionCreators<span class="token punctuation">,</span> dispatch</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// actionCreators如果是函数，就认为就是一个actionCreator函数，</span>
  <span class="token comment">// 直接调用bindActionCreator转换生成一个可以用dispatch派发的action</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> actionCreators <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">bindActionCreator</span><span class="token punctuation">(</span>actionCreators<span class="token punctuation">,</span> dispatch<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 传入的只能是对象或者函数，函数在上面已经进行操作了</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> actionCreators <span class="token operator">!==</span> <span class="token string">'object'</span> <span class="token operator">||</span> actionCreators <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">bindActionCreators expected an object or a function, instead received </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
        actionCreators <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">'null'</span> <span class="token punctuation">:</span> <span class="token keyword">typeof</span> actionCreators
      <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">. </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Did you write &quot;import ActionCreators from&quot; instead of &quot;import * as ActionCreators from&quot;?</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 这里处理actionCreators是一组包含actionCreator的对象时</span>
  <span class="token keyword">const</span> boundActionCreators <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> actionCreators<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> actionCreator <span class="token operator">=</span> actionCreators<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> actionCreator <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 每一个key再次调用bindActionCreator进行转换</span>
      boundActionCreators<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">bindActionCreator</span><span class="token punctuation">(</span>actionCreator<span class="token punctuation">,</span> dispatch<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 返回处理后的对象</span>
  <span class="token keyword">return</span> boundActionCreators
<span class="token punctuation">}</span>
</code></pre></div><h2 id="组合函数-compose"><a href="#组合函数-compose" aria-hidden="true" class="header-anchor">#</a> 组合函数 - compose</h2> <p>函数式编程中常用的方法。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>funcs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 没有参数的话直接返回一个函数组件</span>
  <span class="token comment">// compose()(a) -&gt; a</span>
  <span class="token comment">// 先返回一个返回自身参数的函数 -&gt; 函数执行,返回a</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>funcs<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token parameter">arg</span> <span class="token operator">=&gt;</span> arg
  <span class="token punctuation">}</span>

  <span class="token comment">// 只有一个函数参数时返回该函数参数</span>
  <span class="token comment">// compose(withA)(a) -&gt; withA(a)</span>
  <span class="token comment">// 先返回一个withA函数 -&gt; 函数执行,并且参数为a</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>funcs<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> funcs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 用reduce遍历funcs，并且形成最终需要执行的函数</span>
  <span class="token comment">// compose(withA, withB, withC, withD)(a) </span>
  <span class="token comment">// -&gt; withA(withB(withC(withD(a))))</span>
  <span class="token keyword">return</span> funcs<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token function">b</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 当a，b参数为withA，withB时， return (...args) -&gt; withA(withB(...args))</span>
  <span class="token comment">// 当a，b参数为上一轮返回函数，withC时， </span>
  <span class="token comment">// return (...args2) -&gt; (...args) =&gt; withA(withB(...args))(withC(...args2)) </span>
  <span class="token comment">// 执行结果为： </span>
  <span class="token comment">// (...args2) =&gt; withA(withB(withC))(withC(...args2))</span>
  <span class="token comment">// ... 持续执行,最终结果返回一个函数，函数的参数放在funcs最后一个函数：</span>
  <span class="token comment">// (...argsN) =&gt; withA(withB(withC(...withN(...argsN))))</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="参考链接"><a href="#参考链接" aria-hidden="true" class="header-anchor">#</a> 参考链接</h2> <p><a href="https://github.com/reduxjs/redux" target="_blank" rel="noopener noreferrer">redux github仓库<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://github.com/fi3ework/blog/issues/7" target="_blank" rel="noopener noreferrer">通过Github Blame深入分析Redux源码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://juejin.im/post/5d308b2c6fb9a07ec63b4cad#heading-0" target="_blank" rel="noopener noreferrer">一次性彻底吸收 Redux 源码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://juejin.im/post/5bc318b25188255c5f5414e7" target="_blank" rel="noopener noreferrer">更好用的 Redux<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://llh911001.gitbooks.io/mostly-adequate-guide-chinese/content/" target="_blank" rel="noopener noreferrer">JS函数式编程指南<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">9/12/2019, 11:32:53 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/front/React/React使用总结.html" class="prev">
          React使用总结
        </a></span> <span class="next"><a href="/front/React/React常见面试题.html">
          React 常见面试题
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.da8adb1d.js" defer></script><script src="/assets/js/2.96de6bcb.js" defer></script><script src="/assets/js/39.ab623e87.js" defer></script>
  </body>
</html>
