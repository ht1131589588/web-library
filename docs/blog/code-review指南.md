# Code Review 指南

目录：

- Code Review 目标和原则
- Code Review 的前提条件
- Code Review 关注点
- Code Review 步奏
- Code Review 总结

Code Review，即代码审查，是指一种有意识和系统的召集其他程序员来检查彼此的代码是否有错误的地方.

## Code Review 目标和原则

目标：

- 提高代码质量和可维护性，可读性等.
- 查漏补缺，发现一些潜在的问题点等.
- 总结能够更好更快的完成任务的方法.
- 知识分享，Review他人代码时，其实也是一个学习的过程，自己也会反思&总结.

从其目标我们就可以看出Code Review 的第一原则：对事不对人。这一点需要reviewer、author达成共识。Code Review不是批斗大会，reviewer、author并没有高低之分。

## Code Review 的前提条件

Code Review本身属于"事后"工作，可以起到查漏被缺的作用.

- 建立规范，包含：
  - 编码规范，如变量命名，文件命名规范等
  - 设计原则，如单一职责原则，最少知识原则等
  - 分支管理策略
  - git commit 规范
- 完善的文档，方便查阅
- 制定Code Review流程&目标，以及实施周期。

## Code Review 关注点

一般一个需求开发的完整生命周期会包含以下过程：

- 需求分析，考虑人员情况、功能预期上线时间、技术难度等诸多因素，与PM讨论合理调整需求，分配资源；
- 整体设计，对设计进行review；
- 代码开发；
- 开发自我review，观察、思考与整体设计的出入，保证代码遵循团队规范（至少得通过静态代码检查）；
- 添加相应的单元测试，并保证已有的单元测试不受影响；（暂无）
- Code Review，请相关同事对代码进行review，修复review中发现的问题；
- 提交代码给QA测试，QA会进行功能测试、集成测试、性能测试、压力测试等；
- 修复测试发现的bug后功能上限。


从上述流程可以看出：

- 其实应该有两次定位不同的review：
  - 对整体设计的review，主要目的是从大方向上保证设计确实能满足需求；
  - 其次是Code Review，保证代码实现符合设计约束，且编码没有明显的缺陷。
- 用来Code Review的代码，应该既满足团队代码规范，又基本保证功能的正确。


这里主要关注的是Code Review，Code Review 关注点可以梳理为以下几点：

- git commit提交规范
  - feat: 新特性
  - fix: 修改问题
  - refactor: 代码重构
  - docs: 文档修改
  - chore: 其他修改
  - test: 测试用例修改
  - style: 代码格式修改等等
- 是否满足功能需求：有没有多做，有没有少做，有没有潜在的bug。
- 是否满足非功能需求：性能（高频调用的函数、核心算法）？可用性（异常处理是否完善）？可读性？
- 代码规范
  - 可读性
  - 命名
  - 函数体长度/类长度
    - 函数体太长，不好阅读，一般建议不要超过50行
    - 类太长，如超过10000行，那可能就要看下是否违反了"单一职责"原则.
  - 参数个数：不要太多，一般不要超过3个，超过3个，建议使用对象
- 代码质量
  - 注释：恰到好处的注释，能够帮助我们理解函数/类的作用。
  - 单一职责原则：这是经常被违背的原则，也是最难运用好的原则.
    - 一个类只做一类相关的事情
    - 一个函数/方法，最好只做一件事情
  - 行为是否统一：错误处理、错误提示、弹出框等等是否统一
  - 代码污染：代码有没有对其他模块强耦合
  - 重复代码：主要看有没有把公用组件，可复用的代码、函数抽取出来
  - 开放-封闭原则：简单理解是，看代码好不好扩展
  - 健壮性：(和是否满足功能需求、是否满足非功能需求两点部分重合)
    - 核心数据有没有强制校验？
    - 对业务有没有考虑完整，逻辑是否健壮
    - 有没有潜在的bug？
    - 有没有内存泄露？有没有循环依赖？
  - 错误处理：有没有很好的Error Handling? 如网络出错， IO出错等.
  - 性能：
    - 接口调用时机是否合适？（高频接口可能影响后端性能）
    - 接口是否需要在服务端进行请求？
    - 前端其他性能关注点

上面描述的点有很多，但关注的点一般与项目的代码量成正比，很简单的迭代需求，可能只需要大概扫一下代码就行了。

## Code Review 步奏

Code Review 并不简单是一堆人一起看代码，要让Code Review的效果最大化，整个流程是需要认真组织的：

review前：

- author得保证代码质量：代码满足团队规范且基本测试通过
- author至少提前一天通知参与review会议的同事，提供必要的需求、设计文档
- reviewer简单了解需求、设计、代码实现

这里需要注意的是，与会人员越少越好，无关的同事最好不要参加review。如果与会者对相关的功能不感兴趣，那么就存粹是在浪费时间，这也是很多人不喜欢Code Review的原因。


review中：

- author大致讲解需求和整体设计，然后是核心代码
- reviewer提出问题，author确认是否是问题
- 对发现的问题进行记录，分类处理

Code Review本身是个高强度的活动，因此容易漏掉一些关键点点，因此不妨做一个review list，对照这个list去考察代码。list保证了Code Review的质量下限，且不影响与会者发挥主观能动性，发现其他问题。

此外，也需要避免在没有明确规范的问题下过多争执。达到同样的效果，A方法可以，B方法也可以，如果团队没有约束用哪种方法，那么就不要在code review的时候讨论。


review后：

review会议结束并不意味这个review这个活动结束，因为还有待解决的问题，因此应该借助工具跟踪review发现的问题，指明问题的修复者、问题的验收人、问题的验收时间。当一次review所关联的所有问题都得到修复之后，review活动才算结束。


## 总结

如何才能code review有效且高效，总结以下几点：

- 会前充分准备，与会人员最少化
- 参考review list，发现问题但不发散去讨论解决问题
- 会后跟进问题修复

参考文章：

- https://www.cnblogs.com/xybaby/p/12601471.html
- https://juejin.cn/post/6844904009065578510